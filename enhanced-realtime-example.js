const { IgApiClient } = require('./dist/index');
const fs = require('fs');

/**
 * Exemplu de utilizare a serviciului realtime MQTT √ÆmbunƒÉtƒÉ»õit
 * 
 * Acest exemplu demonstreazƒÉ cum sƒÉ:
 * 1. Te conectezi la Instagram
 * 2. Activezi serviciul realtime MQTT √ÆmbunƒÉtƒÉ»õit
 * 3. Ascul»õi evenimente √Æn timp real cu stabilitate √ÆmbunƒÉtƒÉ»õitƒÉ
 * 4. Gestionezi erorile »ôi reconectarea automatƒÉ
 */
async function enhancedRealtimeExample() {
  const ig = new IgApiClient();
  
  try {
    console.log('üöÄ Starting Instagram Enhanced Realtime MQTT Example...\n');
    
    // ============================================
    // 1. AUTHENTICATION
    // ============================================
    console.log('üìù 1. Authentication');
    
    // Check if we have a saved session
    const sessionFile = 'session.json';
    let loggedIn = false;
    
    if (fs.existsSync(sessionFile)) {
      console.log('   üìÅ Loading saved session...');
      try {
        const session = JSON.parse(fs.readFileSync(sessionFile));
        await ig.loadSession(session);
        
        if (await ig.isSessionValid()) {
          console.log('   ‚úÖ Session is valid!');
          loggedIn = true;
        } else {
          console.log('   ‚ùå Session expired, need to login again');
        }
      } catch (error) {
        console.log('   ‚ùå Failed to load session:', error.message);
      }
    }
    
    // Login if not already logged in
    if (!loggedIn) {
      console.log('   üîê Logging in...');
      
      // REPLACE WITH YOUR CREDENTIALS
      const credentials = {
        username: 'your_username',
        password: 'your_password',
        email: 'your_email@example.com'
      };
      
      try {
        await ig.login(credentials);
        console.log('   ‚úÖ Login successful!');
        
        // Save session for future use
        const session = await ig.saveSession();
        fs.writeFileSync(sessionFile, JSON.stringify(session));
        console.log('   üíæ Session saved!');
        
      } catch (error) {
        console.log('   ‚ùå Login failed:', error.message);
        return;
      }
    }
    
    // ============================================
    // 2. ENHANCED REALTIME MQTT CONNECTION
    // ============================================
    console.log('\nüì° 2. Enhanced Realtime MQTT Connection');
    
    // Configure enhanced realtime options
    ig.setEnhancedRealtimeReconnectOptions({
      maxAttempts: 10,
      delay: 5000
    });
    
    // Set ping interval to 30 seconds
    ig.setEnhancedRealtimePingInterval(30000);
    
    // Set fallback polling interval to 10 seconds
    ig.setEnhancedRealtimeFallbackPollingInterval(10000);
    
    // Set up event listeners for enhanced realtime events
    setupEnhancedRealtimeEventListeners(ig);
    
    // Connect to enhanced MQTT broker
    console.log('   üîå Connecting to enhanced MQTT broker...');
    try {
      await ig.connectEnhancedRealtime();
      console.log('   ‚úÖ Connected to enhanced MQTT broker!');
      
      // Show enhanced realtime stats
      const stats = ig.getEnhancedRealtimeStats();
      console.log('   üìä Enhanced Realtime Stats:', JSON.stringify(stats, null, 2));
      
    } catch (error) {
      console.log('   ‚ùå Failed to connect to enhanced MQTT:', error.message);
      return;
    }
    
    // ============================================
    // 3. ENHANCED REALTIME EVENT HANDLING
    // ============================================
    console.log('\nüëÇ 3. Listening for Enhanced Realtime Events');
    console.log('   üì± Listening for:');
    console.log('   - Push notifications (/fbns_msg)');
    console.log('   - Direct messages (/ig_message)');
    console.log('   - Presence updates (/ig_presence)');
    console.log('   - Typing indicators (/ig_typing)');
    console.log('   - Activity notifications (/ig_activity)');
    console.log('\n   üõ°Ô∏è Enhanced features:');
    console.log('   - Automatic reconnection with exponential backoff');
    console.log('   - Periodic ping to maintain connection');
    console.log('   - Fallback polling mode if MQTT fails');
    console.log('   - Robust error handling');
    console.log('\n   ‚è≥ Waiting for events... (Press Ctrl+C to stop)');
    
    // Keep the process running to listen for events
    process.on('SIGINT', async () => {
      console.log('\n\nüõë Shutting down...');
      
      // Disconnect enhanced realtime
      if (ig.isEnhancedRealtimeConnected()) {
        console.log('   üì° Disconnecting from enhanced MQTT...');
        ig.disconnectEnhancedRealtime();
      }
      
      // Clean up
      ig.destroy();
      console.log('   ‚úÖ Cleanup complete. Goodbye!');
      process.exit(0);
    });
    
    // Keep alive - ping every 30 seconds (handled automatically by enhanced service)
    console.log('   üèì Ping interval: 30 seconds (automatic)');
    
  } catch (error) {
    console.error('\n‚ùå Fatal error:', error.message);
    console.error('Full error:', error);
  }
}

/**
 * ConfigureazƒÉ event listener-ii pentru serviciul realtime √ÆmbunƒÉtƒÉ»õit
 * @param {IgApiClient} ig - Clientul Instagram
 */
function setupEnhancedRealtimeEventListeners(ig) {
  // Event generic pentru toate evenimentele realtime
  ig.enhancedRealtime.on('realtimeEvent', (event) => {
    console.log(`\nüì® [${event.timestamp}] Enhanced Realtime Event:`);
    console.log(`   Topic: ${event.topic}`);
    console.log(`   Payload: ${JSON.stringify(event.payload, null, 2)}`);
  });
  
  // Event-uri specifice pentru fiecare tip de mesaj
  ig.enhancedRealtime.on('pushNotification', (payload) => {
    console.log('\nüîî Push Notification:', JSON.stringify(payload, null, 2));
  });
  
  ig.enhancedRealtime.on('directMessage', (payload) => {
    console.log('\nüí¨ Direct Message:', JSON.stringify(payload, null, 2));
  });
  
  ig.enhancedRealtime.on('presenceUpdate', (payload) => {
    console.log('\nüë§ Presence Update:', JSON.stringify(payload, null, 2));
  });
  
  ig.enhancedRealtime.on('typingIndicator', (payload) => {
    console.log('\n‚å®Ô∏è Typing Indicator:', JSON.stringify(payload, null, 2));
  });
  
  ig.enhancedRealtime.on('activityNotification', (payload) => {
    console.log('\nüéØ Activity Notification:', JSON.stringify(payload, null, 2));
  });
  
  // Event-uri de conexiune
  ig.enhancedRealtime.on('connected', () => {
    console.log('   ‚úÖ Enhanced MQTT Connected');
  });
  
  ig.enhancedRealtime.on('disconnected', () => {
    console.log('   ‚ùå Enhanced MQTT Disconnected');
  });
  
  ig.enhancedRealtime.on('reconnecting', (data) => {
    console.log(`   üîÑ Enhanced MQTT Reconnecting... (attempt ${data.attempt}/${data.maxAttempts})`);
  });
  
  ig.enhancedRealtime.on('offline', () => {
    console.log('   üì¥ Enhanced MQTT Offline');
  });
  
  ig.enhancedRealtime.on('error', (error) => {
    console.error('   ‚ùå Enhanced MQTT Error:', error.message);
  });
  
  ig.enhancedRealtime.on('ping', () => {
    console.log('   üèì Enhanced MQTT Ping sent');
  });
  
  // Event-uri pentru fallback mode
  ig.enhancedRealtime.on('fallbackModeEnabled', () => {
    console.log('   üîÑ Fallback mode enabled - switching to polling');
  });
  
  ig.enhancedRealtime.on('fallbackModeDisabled', () => {
    console.log('   ‚úÖ Fallback mode disabled - back to MQTT');
  });
  
  ig.enhancedRealtime.on('fallbackPolling', () => {
    console.log('   üì° Fallback polling...');
  });
}

// Run the example
if (require.main === module) {
  console.log('====================================');
  console.log('üì° Instagram Enhanced Realtime MQTT Example');
  console.log('====================================');
  console.log('');
  console.log('‚ö†Ô∏è  IMPORTANT NOTES:');
  console.log('1. Replace credentials with your own');
  console.log('2. Make sure you have a valid Instagram session');
  console.log('3. The enhanced MQTT connection provides better stability');
  console.log('4. Features automatic reconnection and ping intervals');
  console.log('5. Includes fallback polling mode if MQTT fails');
  console.log('6. Use responsibly and follow Instagram ToS');
  console.log('');
  
  enhancedRealtimeExample().catch(console.error);
}

module.exports = enhancedRealtimeExample;